---
title: "Project"
author: "Jan Sifrer"
date: "5. 4. 2022"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, include=FALSE, echo=FALSE}
#source("program.R", encoding="UTF-8")
```

# Which elements most often clog the power grid? 

First, let's see who congested more than 10 times:
```{r, echo=FALSE}
#First, let's see who congested more than 10 times:
#firs_one <- Grouped_el[Grouped_el$Sum > 10,]
#kable(firs_one)
```
**INTERPRETATIONS:**

* ALBE_export was congested 51 times in this period
* The German power grid was congested for 35 times by [DE-DE] Hoheneck - Pulverdingen weiss [DIR] [DE]


Second, let's see who congested more than 2 times, but less than 10 times:
```{r, echo=FALSE}
#Second, let's see who congested more than 2 times, but less than 10 times:
#second <- Grouped_el[Grouped_el$Sum > 2 & Grouped_el$Sum <= 10,]
#kable(second)
```

And now let see who congested less than 2 times:
```{r, echo=FALSE}
#And now let see who congested less than 2 times:
#third <- Grouped_el[Grouped_el$Sum <= 2,]
#kable(third)
```

**Conclusion:**

In the first table, we can see, which elements congested the power grid more than 10 times. We can also see, that all these elements are part of German or Belgium power grid.

In the second table, we can see, which elements congested the power grid more than 2 times, but less than 10 times. We can see that the elements are parts of many different power grids. They are part of Belgium, France, Netherlands, German, and Austria power grids.

And in the last table, we can see, which elements congested the power grid at least once, but less than 2 times. But for better transparency let's merge this table by a fact in which country they are. (By the first part of the Name.)
```{r, echo=FALSE}
#group <- Grouped_el_2
#kable(group)
```

We can see, that although the element's in the Austrian power grid are not in the first table and they are barely in the second (so none of the elements didn't clog the grid more than 10 times, and just one element is in the second table - Westtirol Transformer WTRHU41 [DIR], which congested the grid 3 times), the Austrian power grid is the most congested in this observed period.

That can be confirmed by the table below, where we can see, how many times was some power grid congested. (Let's just see those, who were congested more than 20 times.)
```{r, echo=FALSE}
#grouped2 <- Grouped[Grouped$Sum > 20,]
#kable(grouped2)
```

```{r, include=FALSE, echo=FALSE}
# source("Shiny/shiny.r", encoding = "UTF-8")

#source("library.r", encoding="UTF-8")

library(shiny)
library(shinythemes)
library(readr)
library(dplyr)
library(stringr)
library(lme4)
library(knitr)

# Load data
trend_data <- read_csv("koef.csv",col_types = cols(Time = col_character()))

# Define UI
ui <- fluidPage(theme = shinytheme("lumen"),
                titlePanel("Congested grids"),
                sidebarLayout(
                  sidebarPanel(
                    
                    # Select type of trend to plot
                    selectInput(inputId = "name2", label = strong("Name of Grid"),
                                choices = unique(trend_data$Name2)[order(unique(trend_data$Name2))],
                                selected = "Diele - Meeden 380 Black [DIR] [DE]"),
                    
                    selectInput(inputId = "time", label = strong("Hour"),
                                choices = unique(trend_data$Time),
                                selected = "00:00:00"),
                    
                    selectInput(inputId = "day", label = strong("Day of the week"),
                                choices = unique(trend_data$Day)[order(unique(trend_data$Day))],
                                selected = 1),
                    
                    numericInput(inputId = "AT", label = strong("PTDF for AT"),
                                 value = 0.58860, min = -1, max = 1, step = 0.00001),
                    
                    numericInput(inputId = "BE", label = strong("PTDF for BE"),
                                 value = 0.25637, min = -1, max = 1, step = 0.00001),
                    
                    numericInput(inputId = "DE", label = strong("PTDF for DE"),
                                 value = 0.58860, min = -1, max = 1, step = 0.00001),
                    
                    numericInput(inputId = "FR", label = strong("PTDF for FR"),
                                 value = 0.38150, min = -1, max = 1, step = 0.00001),
                    
                    numericInput(inputId = "NL", label = strong("PTDF for NL"),
                                 value = 0, min = -1, max = 1, step = 0.00001),
                    
                    numericInput(inputId = "ALBE", label = strong("PTDF for ALBE"),
                                 value = -0.30955, min = -1, max = 1, step = 0.00001),
                    
                    numericInput(inputId = "ALDE", label = strong("PTDF for ALDE"),
                                 value = 0, min = -1, max = 1, step = 0.00001),
                    
                    numericInput(inputId = "RAM", label = strong("RAM"),
                                 value = 1399, min = 0, max = 99999, step = 0.01),
                    
                    
                  ),
                  
                  # Output: Description, lineplot, and reference
                  mainPanel(
                    tableOutput(outputId = "table"),
                    plotOutput(outputId = "lineplot", height = "300px")
                    # textOutput(outputId = "desc"),
                    # tags$a(href = "https://www.google.com/finance/domestic_trends", "Source: Google Domestic Trends", target = "_blank")
                  )
                )
)

# Define server function
server <- function(input, output) {
  
  # Create scatterplot object the plotOutput function is expecting
  hh2 <- lmer(c ~ AT + BE + DE + FR + NL + ALBE + ALDE + RAM + (1|Name2/Day) + (1|Name2/Time), data = trend_data)
  
  output$lineplot <- renderPlot({
    # plot(1,1, type='l')
    trend_data1 <- trend_data[trend_data$Name2==input$name2,]
    trend_data1 <- trend_data1[trend_data1$Time==input$time,]
    plot(trend_data1$c, type='l')
    #color = "#434343"
    #par(mar = c(4, 4, 1, 1))
    # plot(selected_trends()$c, type = "l",
    #      xlab = "Date", ylab = "Trend index", col = color, fg = color, col.lab = color, col.axis = color)
    # Display only if smoother is checked
    #if(input$smoother){
    # print(1+1)
    #}
  })
  
  # Pull in description of trend
  output$table <- renderTable({
    
    PTDF <- data.frame("Day"=input$day,"Name2"=input$name2, "Time"=input$time, "AT"=input$AT, "BE"=input$BE, "DE"=input$DE, "FR"=input$FR, "NL"=input$NL, "ALBE"=input$ALBE, "ALDE"=input$ALDE, "RAM"=input$RAM)
    
    out <- tryCatch(
      {
        v = predict(hh2,PTDF)
      },
      error=function(cond) {
        return(0)
      }#,
      # finally = {
      #   v
      # }
    )
    interval <- c(out - 1.96*sigma(hh2), out + 1.96*sigma(hh2))
    if (out == 0){hh = data.frame("Change some parameters!" = out)}
    else{
      hh = data.frame("low boundary" = interval[1], "value" = out, "High boundary" = interval[2], "RAM" = input$RAM, "RAM - Value" = input$RAM - out)}
    print(hh)
  })
}
```

```{r, echo=FALSE}
# Create Shiny object
shinyApp(ui = ui, server = server)
```
